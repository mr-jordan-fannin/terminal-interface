<!DOCTYPE html>
<html lang="en">

<head>
	<meta content="text/html">
	<meta charset="utf-8">
	<style>
		@font-face {
			font-family: 'MorePerfectDOSVGA';
			src: url('MorePerfectDOSVGA.ttf') format('truetype');
		}
		body {
			background-color: rgb(0,0,0);
			font-family: "MorePerfectDOSVGA", Courier, monospace;
			font-size: 1em;
		}
        #workstation {
            width: 100%;
        }

        #terminal, #monitor {
            height: 40em;
            margin: 1em;
            overflow-y: auto;
            width: 47%;
        }
        #terminal:before, #monitor:before {
            animation: scanline 5s linear infinite;
            content: '';
            font-size: .1em;
            height: .1em;
            opacity: .5;
            position: absolute;
            width: inherit;
        }
        #terminal-filter, #monitor-filter {
            height: inherit;
            opacity: .8;
        }
        #console, #status {
            padding: 1em;
        }

		#terminal {
			background-color: rgb(0,15,0);
			color: lime;
            float: left;
		}
		#terminal:before {
			background: lime;
		}
        #terminal-filter {
            background: linear-gradient(#020 1%, black 99%);
            height: 100%;
            width: 100%;
        }
		.line {
			white-space: pre;
			word-wrap: break-word;
		}

		#monitor {
			background-color: rgb(15,15,0);
			color: orange;
			float: right;
		}
		#monitor:before {
			background: orange;
		}
		#monitor-filter {
            background: linear-gradient(#220 1%, black 99%);
            width: 100%;
		}
		#status h2 {
			text-align: center;
		}

        #terminal-filter, #monitor-filter {
            background-repeat: repeat-y;
            background-size: 100% .2em;
        }

		@keyframes scanline {
			0% {
                top: 25px;
                width: inherit
            }
			100% {
                top: 500px;
                width: inherit
            }
		}
		@media only screen and (max-width: 700px) {
            #terminal {

            }
            #monitor {

            }
		}
	</style>
	<title>TERMINAL</title>
</head>

<body>
    <div id="workstation">
        <div id="terminal">
            <div id="terminal-filter">
                <div id="console">
                    <div id="line0" class="line"><span class="prompt">> </span><span id="cursor">█</span></div>
                </div>
            </div>
        </div>
        <div id="monitor">
            <div id="monitor-filter">
                <div id="status">
                    <h2>ANDROID STATUS</h2>
                    <p>AGE: <span id="age">0</span> SECONDS</p>
                    <p>ENERGY: <span id="energy">100</span>%</p>
                    <p>HEALTH: <span id="health">100</span>%</p>
                    <p>TEMPERATURE: <span id="temp">50</span> C</p>
                    <p>X SECTION: <span id="xsec">1</span></p>
                    <p>Y SECTION: <span id="ysec">1</span></p>
                    <p>DECK: <span id="deck">1</span></p>
                    <p>ORIENTATION: <span id="orientation">VERTICAL</span></p>
                    <p>ATTITUDE: CURIOUS</p>
                </div>
            </div>
        </div>
    </div>
</body>

<script type="application/javascript" language="javascript">

    // TODO: MAKE CURSOR A SUPERIMPOSING RECTANGLE INSTEAD OF A CHARACTER
    // TODO: FIX BACKGROUND SCROLL UP WHEN ACTIVE LINE REACHES BOTTOM OF CONSOLE
    // TODO: SET SOME INTERVAL TO DELAY INCREMENTING IN ANDROID.WALK() TO SIMULATE WALKING TIME
    // TODO: ADJUST SIZING FOR BETTER RESPONSIVENESS

    //**********GLOBALS**********

    const grid = {
        row: 0,
        col: 0,
        reset: function () {
            this.row = 0;
            this.col = 0;
            input.command = '';
        }
    };
    const input = {
        command: '',
        history: [],
        index: 0,
        first: function() {
            return input.command.slice(0, grid.col);
        },
        last: function() {
            return input.command.slice(grid.col, input.command.length);
        },
        cycle: function(dir) {
            if (dir === 'Up' && input.index > 0) {
                input.index--;
            }
            if (dir === 'Down' && input.index < input.history.length - 1) {
                input.index++;
            }
            input.command = input.history[input.index];
            grid.col = input.command.length;
        },
        slide: function(dir) {
            if (dir === 'Left' && grid.col > 0) {
                grid.col--;
            }
            if (dir === 'Right' && grid.col < input.command.length) {
                grid.col++;
            }
        },
        space: function() {
            input.command = input.first() + ' ' + input.last();
            grid.col++;
        },
        back: function() {
            if (grid.col > 0) {
                grid.col--;
            }
            if (input.command.length > 0) {
                input.command = input.first() + input.command.slice(grid.col + 1, input.command.length);
            }
        },
        text: function() {
            if (event.code.startsWith('Key') || event.code.startsWith('Digit')) {
                input.command = input.first() + event.key.toUpperCase() + input.last();
                grid.col++;
            }
        },
        symbol: function(char) {
            input.command += char;
            grid.col++;
        },
        enter: function() {
            settings.current().innerHTML = settings.prompt + input.command;
            input.process();
            input.archive();
            settings.current().scrollIntoView(false);
        },
        newline: function() {
            grid.row++;
            grid.col = 0;
            settings.console.innerHTML += settings.clean();
            settings.console.scrollTop = settings.console.scrollHeight;
        },
        archive: function() {
            input.history.push(input.command);
            input.index = input.history.length;
            input.command = '';
        },
        process: function() {
            switch (input.command) {
                case 'CLEAR':
                    commands.clear();
                    break;
                case 'DIAG':
                    commands.diagnostic();
                    break;
                case 'HELP':
                    commands.help();
                    break;
                case 'WAIT':
                    commands.wait();
                    break;
                default:
                    if (input.command.startsWith('MOVE')) {
                        android.walk();
                    } else {
                        input.newline();
                    }
                    break;
            }
        }
    };
    const settings = {
        version: '0.0.9',
        fcolor: 'rgba(0, 255, 0, 1)',
        dcolor: 'rgba(0, 15, 0, 0)',
        rate: 600,
        prompt: '<span class="prompt">> </span>',
        cursor: '<span id="cursor">█</span>',
        console: document.getElementById('console'),
        current: function() {
            return document.getElementById('line' + grid.row);
        },
        clean: function() {
            return '<div id="line' + grid.row + '" class="line">' + settings.prompt + settings.cursor + '</div>';
        }
    };
    const ship = {
        decks: 20,
        xsections: 30,
        ysections: 50
    };
    const android = {
        stats: {
            xsec: 1,
            ysec: 1,
            deck: 1,
            age: 0,
            energy: 100,
            health: 100,
            temp: 50,
            orientation: 'VERTICAL'
        },
        autopilot: function() {
            setInterval(function () {
                android.stats.age++;
                if (android.stats.age % 10 === 0 && android.stats.energy !== 0) {
                    android.stats.energy--;
                }
                if (Math.round(Math.random() * 10) < 2) {
                    android.stats.orientation = 'HORIZONTAL';
                    android.stats.health--;
                } else {
                    android.stats.orientation = 'VERTICAL';
                }
                for (let property in android.stats) {
                    if (android.stats.hasOwnProperty(property)) {
                        document.getElementById(property).innerHTML = android.stats[property];
                    }
                }
            }, 1000);
        },
        talk: function(message) {
            grid.row++;
            settings.console.innerHTML += '<div id="line' + grid.row + '" class="line"></div>';
            let i = 0;
            let character = setInterval(function() {
                if (i === message.length) {
                    input.newline();
                    clearInterval(character);
                } else {
                    (i === 0) ? settings.current().innerHTML = '&nbsp' + message[i] : settings.current().innerHTML += message[i];
                    i++;
                }
            }, 50);
        },
        walk: function() {
            const dir = input.command.charAt(5);
            let steps = parseInt(input.command.charAt(7));
            for (let i = 0; i < steps; i++) {
                switch (dir) {
                    case 'U':
                        if (android.stats.deck < ship.decks) {
                            android.stats.deck++;
                        } else {
                            grid.row++;
                            settings.console.innerHTML += '<div id="line' + grid.row + '">YOU HAVE REACHED THE DORSAL INTERIOR HULL</div>';
                            steps = 0;
                        }
                        break;
                    case 'D':
                        if (android.stats.deck > 1) {
                            android.stats.deck--;
                        } else {
                            grid.row++;
                            settings.console.innerHTML += '<div id="line' + grid.row + '">YOU HAVE REACHED THE VENTRAL INTERIOR HULL</div>';
                            steps = 0;
                        }
                        break;
                    case 'F':
                        if (android.stats.ysec < ship.ysections) {
                            android.stats.ysec++;
                        } else {
                            grid.row++;
                            settings.console.innerHTML += '<div id="line' + grid.row + '">YOU HAVE REACHED THE BOW INTERIOR HULL</div>';
                            steps = 0;
                        }
                        break;
                    case 'A':
                        if (android.stats.ysec > 1) {
                            android.stats.ysec--;
                        } else {
                            grid.row++;
                            settings.console.innerHTML += '<div id="line' + grid.row + '">YOU HAVE REACHED THE STERN INTERIOR HULL</div>';
                            steps = 0;
                        }
                        break;
                    case 'S':
                        if (android.stats.xsec < ship.xsections) {
                            android.stats.xsec++;
                        } else {
                            grid.row++;
                            settings.console.innerHTML += '<div id="line' + grid.row + '">YOU HAVE REACHED THE STARBOARD INTERIOR HULL</div>';
                            steps = 0;
                        }
                        break;
                    case 'P':
                        if (android.stats.xsec > 1) {
                            android.stats.xsec--;
                        } else {
                            grid.row++;
                            settings.console.innerHTML += '<div id="line' + grid.row + '">YOU HAVE REACHED THE PORT INTERIOR HULL</div>';
                            steps = 0;
                        }
                        break;
                    default:
                        break;
                }
            }
            document.getElementById('xsec').innerHTML = android.stats.xsec;
            document.getElementById('ysec').innerHTML = android.stats.ysec;
            document.getElementById('deck').innerHTML = android.stats.deck;
            console.log(android.stats.xsec, ' ', android.stats.ysec, ' ', android.stats.deck);
            input.newline();
        }
    };
	const commands = {
        list: [
            'CLEAR: CLEARS THE CONSOLE SCREEN.',
            'DIAG: RUN SELF-DIAGNOSTIC ROUTINE.',
            'DROP [OBJ]: SET DOWN [OBJ] HERE.',
            'EXAM [OBJ]: EXAMINE THE ROOM (DEFAULT) OR [OBJ].',
            'MOVE [DIR] [NUM]: WALK [NUM] ROOMS HEADING [DIR].',
            'TAKE [OBJ]: PICK UP AND CARRY [OBJ].'
        ],
        clear: function() {
            grid.reset();
            settings.console.innerHTML = settings.clean();
        },
        diagnostic: function() {
            android.talk('I AM FEELING FINE, THANKS. HOW ARE YOU?');
        },
        help: function() {
            grid.row++;
            settings.console.innerHTML += '<div id="line' + grid.row + '">ANDROID COMMAND SHELL VERSION ' + settings.version + '</div>';
            grid.row++;
            settings.console.innerHTML += '<div id="line' + grid.row + 'TYPE \'HELP\' TO SEE THIS LIST.' + '"</div>';
            grid.row++;
            settings.console.innerHTML += '<div id="line' + grid.row + '">VALID COMMANDS:</div>';
            for (let i = 0; i < commands.list.length; i++) {
                grid.row++;
                settings.console.innerHTML += '<div id="line' + grid.row + '">&nbsp' + commands.list[i] + '</div>';
            }
            input.newline();
        },
        wait: function() {
            const stages = ['-','\\','|','/'];
            grid.row++;
            settings.console.innerHTML += '<div id="line' + grid.row + '"><span id="waiter"></span></div>';
            grid.col = 0;
            let i = 0;
            let waitSpin = setInterval(function () {
                if (document.getElementById('waiter')) {
                    document.getElementById('waiter').innerHTML = stages[i];
                    i++;
                    if (i > stages.length - 1) {
                        i = 0;
                    }
                } else {
                    clearInterval(waitSpin);
                }
            }, settings.rate);
        },
    };
    const directory = [
        {
            type: "folder",
            name: "root",
            path: "/",
            children: [
                {
                    type: "folder",
                    name: "logs",
                    path: "/logs",
                    children: [
                        {
                            type: "folder",
                            name: "images",
                            path: "/logs/images",
                            children: [
                                {
                                    type: "file",
                                    name: "1.jpg",
                                    path: "/logs/images/1.jpg"
                                }
                            ]
                        },
                        {
                            type: "folder",
                            name: "audio",
                            path: "/logs/audio",
                            children: [
                                {
                                    type: "file",
                                    name: "1.mp3",
                                    path: "/logs/images/1.mp3"
                                }
                            ]
                        }
                    ]
                }
            ]
        }
    ];

    android.autopilot();

    // CURSOR BLINK
    setInterval(function() {
        let cursor = document.getElementById('cursor');
        if (cursor) {
            if (cursor.style.color === settings.dcolor) {
                cursor.style.color = settings.fcolor;
            } else {
                cursor.style.color = settings.dcolor;
            }
        }
    }, settings.rate);

    // MAIN LOOP
    window.addEventListener('keydown', function(event) {
        switch (event.code) {
            case 'Backspace':
                input.back();
                break;
            case 'ArrowLeft':
                input.slide('Left');
                break;
            case 'ArrowRight':
                input.slide('Right');
                break;
            case 'Enter':
                input.enter();
                break;
            case 'ArrowUp':
                input.cycle('Up');
                break;
            case 'ArrowDown':
                input.cycle('Down');
                break;
            case 'Space':
                input.space();
                break;
            case 'Period':
                input.symbol('.');
                break;
            case 'Minus':
                input.symbol('-');
                break;
            case 'Slash':
                input.symbol('/');
                break;
            default:
                input.text();
                break;
        }
        /*
        let chars = input.command.split('');
        let content = settings.prompt;
        for (let i = 0; i < chars.length; i++) {
            content += '<span>' + chars[i] + '</span>';
        }
        settings.current().innerHTML = content;
        */
        settings.current().innerHTML = settings.prompt + input.first() + settings.cursor + input.last();
        settings.console.scrollTop = settings.console.scrollHeight;
        event.preventDefault();
    }, true);

</script>

</html>
